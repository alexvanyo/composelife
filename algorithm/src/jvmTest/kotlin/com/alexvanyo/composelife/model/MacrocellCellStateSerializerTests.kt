/*
 * Copyright 2022 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.alexvanyo.composelife.model

import kotlin.test.Test
import kotlin.test.assertEquals
import kotlin.test.assertIs
import kotlin.test.assertTrue

class MacrocellCellStateSerializerTests {

    private val serializer = MacrocellCellStateSerializer

    @Test
    fun basic_deserialization_is_correct() {
        assertEquals(
            DeserializationResult.Successful(
                warnings = emptyList(),
                cellState = setOf(
                    0 to 0,
                    2 to 0,
                    4 to 0,
                    0 to 2,
                    2 to 2,
                    4 to 2,
                    0 to 4,
                    2 to 4,
                    4 to 4,
                ).toCellState(),
                format = CellStateFormat.FixedFormat.Macrocell,
            ),
            serializer.deserializeToCellState(
                $$"""
                |[M2] (ComposeLife 1.0)
                |*.*.*$$*.*.*$$*.*.*$
                """.trimMargin().lineSequence(),
            ),
        )
    }

    @Test
    fun deserialization_with_comments_is_correct() {
        assertEquals(
            DeserializationResult.Successful(
                warnings = emptyList(),
                cellState = setOf(
                    0 to 0,
                    2 to 0,
                    4 to 0,
                    0 to 2,
                    2 to 2,
                    4 to 2,
                    0 to 4,
                    2 to 4,
                    4 to 4,
                ).toCellState(),
                format = CellStateFormat.FixedFormat.Macrocell,
            ),
            serializer.deserializeToCellState(
                $$"""
                |[M2] (ComposeLife 1.0)
                |# This is a comment
                |*.*.*$$*.*.*$$*.*.*$
                """.trimMargin().lineSequence(),
            ),
        )
    }

    @Test
    fun basic_serialization_is_correct() {
        assertEquals(
            $$"""
            |[M2] (ComposeLife 1.0)
            |*.*.*$$*.*.*$$*.*.*$
            """.trimMargin(),
            serializer.serializeToString(
                setOf(
                    0 to 0,
                    2 to 0,
                    4 to 0,
                    0 to 2,
                    2 to 2,
                    4 to 2,
                    0 to 4,
                    2 to 4,
                    4 to 4,
                ).toCellState(),
            ).joinToString("\n"),
        )
    }

    @Test
    fun gosper_glider_gun_serialization_is_correct() {
        assertEquals(
            $$"""
            |[M2] (ComposeLife 1.0)
            |$$$$**$**$
            |$$....**$...*...*$..*$..*...*$..*$...*...*$
            |....**$
            |4 1 2 0 3
            |$......*$....**$....**$*...**$**....*$*$
            |*$*$$$$*$*$
            |4 5 6 0 0
            |5 4 7 0 0
            |$$..**$..**$
            |4 9 0 0 0
            |5 10 0 0 0
            |6 8 11 0 0
            """.trimMargin(),
            serializer.serializeToString(
                """
                |........................O...........
                |......................O.O...........
                |............OO......OO............OO
                |...........O...O....OO............OO
                |OO........O.....O...OO..............
                |OO........O...O.OO....O.O...........
                |..........O.....O.......O...........
                |...........O...O....................
                |............OO......................
                """.toCellState(),
            ).joinToString("\n"),
        )
    }

    @Test
    fun slow_puffer_serialization_is_correct() {
        assertEquals(
            $$"""
            |[M2] (ComposeLife 1.0)
            |$$...*$.*...*$*$*....*$*****$
            |4 0 0 1 0
            |$******$*.....*$*$.*....*$...**$
            |4 0 3 0 0
            |5 0 0 2 4
            |$$$$$....**$...**.**$....****$
            |4 0 0 0 6
            |$$$$$$$....**$
            |$$$$$.......*$......**$.......*$
            |...**.**$....****$.....***$
            |**$**$*$
            |4 8 9 10 11
            |.....**$
            |4 0 13 0 0
            |$$$$$$$......**$
            |$$$$$$$**$
            |.....***$....**.*$.....**$
            |***$***$
            |4 15 16 17 18
            |5 7 12 14 19
            |$$.**$**.***$.****$..**$$.....**$
            |$$.....**$....*.*$***.*$....*.*$.....**$
            |...*$..*$..*$..******$
            |*$$*$
            |4 21 22 23 24
            |$....*$*..*.*$****.*$$****.*$*..*.*$....*$
            |4 26 0 0 0
            |$$$...**$.*....*$*$*.....*$******$
            |4 0 28 0 0
            |5 25 27 0 29
            |$$$$$$.....**$....**.*$
            |$$$$$$$***$
            |4 0 0 31 32
            |.....**$....****$...**.**$....**$
            |4 0 0 0 34
            |.....***$......**$
            |***$**$
            |$$$$$$.....***$....****$
            |$$$$$$*$**$
            |4 36 37 38 39
            |5 0 33 35 40
            |6 5 20 30 41
            |$$$$***$****$.***$*$
            |....**$...**.**$....****$.....***$
            |$$$$$$..**$*....*$
            |4 43 44 0 45
            |$**$**$*$
            |4 47 0 0 0
            |.......*$.......*$.......*$
            |$.....*$*****$
            |4 49 50 0 0
            |5 46 48 51 0
            |$$$$$$.......*$.......*$
            |$$$$$$*****$.....*$
            |.......*$
            |$*....*$..**$
            |4 53 54 55 56
            |5 0 0 57 0
            |6 52 0 58 0
            |...**.**$....**$
            |**$.......*$......**$.......*$
            |4 60 61 0 0
            |5 0 62 0 0
            |6 0 63 0 0
            |$*$.***$****$***$
            |$$$$$.....***$....****$...**.**$
            |....**$
            |4 65 66 0 67
            |$$$$$*$**$**$
            |4 69 0 0 0
            |5 68 70 0 0
            |6 71 0 0 0
            |7 42 59 64 72
            """.trimMargin(),
            serializer.serializeToString(
                """
                |............................................................................OO....
                |...........................................................................OO.OOOO
                |............................................................................OOOOOO
                |.............................................................................OOOO.
                |................................................................OOO...............
                |...............................................................OOOOO..............
                |..............................................................OO.OOO..............
                |....................................................OO.........OO.................
                |...................................................OO.OOOO........................
                |....................................................OOOOOO........................
                |.....................................................OOOO.........................
                |..................................................................................
                |..................................................................................
                |............................................OO....................................
                |...........................................OO.OO..........................OO......
                |............................................OOOO........................O....O....
                |.............................................OO........................O..........
                |........................OOOOOO.........................................O.....O....
                |........................O.....O........................................OOOOOO.....
                |........................O.........................................................
                |.........................O....O...................................................
                |...........................OO.....................................................
                |..................................................................................
                |......................................................OOOO........................
                |.....................................................OOOOOO.......................
                |....................................................OO.OOOO.......................
                |...O.................................................OO...........................
                |.O...O............................................................................
                |O.................................................................................
                |O....O............................................................................
                |OOOOO.............................................................................
                |..................................................................................
                |..................................................................................
                |....................O.............................................................
                |.OO..........OO.O..O.O............................................................
                |OO.OOO......O.O.OOOO.O............................................................
                |.OOOO...OOO.O.....................................................................
                |..OO........O.O.OOOO.O............................................................
                |.............OO.O..O.O............................................................
                |.....OO.............O.............................................................
                |...O....O.........................................................................
                |..O...............................................................................
                |..O.....O.........................................................................
                |..OOOOOO..........................................................................
                |..................................................................................
                |..................................................................................
                |.....................................................OO...........................
                |....................................................OO.OOOO.......................
                |.....................................................OOOOOO.......................
                |......................................................OOOO........................
                |..................................................................................
                |...........................OO.....................................................
                |.........................O....O...................................................
                |........................O.........................................................
                |........................O.....O........................................OOOOOO.....
                |........................OOOOOO.........................................O.....O....
                |.............................................OO........................O..........
                |............................................OOOO........................O....O....
                |...........................................OO.OO..........................OO......
                |............................................OO....................................
                |..................................................................................
                |..................................................................................
                |.....................................................OOOO.........................
                |....................................................OOOOOO........................
                |...................................................OO.OOOO........................
                |....................................................OO.........OO.................
                |..............................................................OO.OOO..............
                |...............................................................OOOOO..............
                |................................................................OOO...............
                |.............................................................................OOOO.
                |............................................................................OOOOOO
                |...........................................................................OO.OOOO
                |............................................................................OO....
                """.toCellState(),
            ).joinToString("\n"),
        )
    }

    @Test
    fun slow_puffer_deserialization_is_correct() {
        assertEquals(
            DeserializationResult.Successful(
                warnings = emptyList(),
                cellState = """
                |............................................................................OO....
                |...........................................................................OO.OOOO
                |............................................................................OOOOOO
                |.............................................................................OOOO.
                |................................................................OOO...............
                |...............................................................OOOOO..............
                |..............................................................OO.OOO..............
                |....................................................OO.........OO.................
                |...................................................OO.OOOO........................
                |....................................................OOOOOO........................
                |.....................................................OOOO.........................
                |..................................................................................
                |..................................................................................
                |............................................OO....................................
                |...........................................OO.OO..........................OO......
                |............................................OOOO........................O....O....
                |.............................................OO........................O..........
                |........................OOOOOO.........................................O.....O....
                |........................O.....O........................................OOOOOO.....
                |........................O.........................................................
                |.........................O....O...................................................
                |...........................OO.....................................................
                |..................................................................................
                |......................................................OOOO........................
                |.....................................................OOOOOO.......................
                |....................................................OO.OOOO.......................
                |...O.................................................OO...........................
                |.O...O............................................................................
                |O.................................................................................
                |O....O............................................................................
                |OOOOO.............................................................................
                |..................................................................................
                |..................................................................................
                |....................O.............................................................
                |.OO..........OO.O..O.O............................................................
                |OO.OOO......O.O.OOOO.O............................................................
                |.OOOO...OOO.O.....................................................................
                |..OO........O.O.OOOO.O............................................................
                |.............OO.O..O.O............................................................
                |.....OO.............O.............................................................
                |...O....O.........................................................................
                |..O...............................................................................
                |..O.....O.........................................................................
                |..OOOOOO..........................................................................
                |..................................................................................
                |..................................................................................
                |.....................................................OO...........................
                |....................................................OO.OOOO.......................
                |.....................................................OOOOOO.......................
                |......................................................OOOO........................
                |..................................................................................
                |...........................OO.....................................................
                |.........................O....O...................................................
                |........................O.........................................................
                |........................O.....O........................................OOOOOO.....
                |........................OOOOOO.........................................O.....O....
                |.............................................OO........................O..........
                |............................................OOOO........................O....O....
                |...........................................OO.OO..........................OO......
                |............................................OO....................................
                |..................................................................................
                |..................................................................................
                |.....................................................OOOO.........................
                |....................................................OOOOOO........................
                |...................................................OO.OOOO........................
                |....................................................OO.........OO.................
                |..............................................................OO.OOO..............
                |...............................................................OOOOO..............
                |................................................................OOO...............
                |.............................................................................OOOO.
                |............................................................................OOOOOO
                |...........................................................................OO.OOOO
                |............................................................................OO....
                """.toCellState(),
                format = CellStateFormat.FixedFormat.Macrocell,
            ),
            serializer.deserializeToCellState(
                $$"""
                |[M2] (ComposeLife 1.0)
                |$$...*$.*...*$*$*....*$*****$
                |4 0 0 1 0
                |$******$*.....*$*$.*....*$...**$
                |4 0 3 0 0
                |5 0 0 2 4
                |$$$$$....**$...**.**$....****
                |4 0 0 0 6
                |$$$$$$$....**
                |$$$$$.......*$......**$.......*
                |...**.**$....****$.....***$
                |**$**$*$
                |4 8 9 10 11
                |.....**$
                |4 0 13 0 0
                |$$$$$$$......**
                |$$$$$$$**
                |.....***$....**.*$.....**$
                |***$***$
                |4 15 16 17 18
                |5 7 12 14 19
                |$$.**$**.***$.****$..**$$.....**
                |$$.....**$....*.*$***.*$....*.*$.....**$
                |...*$..*$..*$..******$
                |*$$*$
                |4 21 22 23 24
                |$....*$*..*.*$****.*$$****.*$*..*.*$....*
                |4 26 0 0 0
                |$$$...**$.*....*$*$*.....*$******
                |4 0 28 0 0
                |5 25 27 0 29
                |$$$$$$.....**$....**.*
                |$$$$$$$***
                |4 0 0 31 32
                |.....**$....****$...**.**$....**$
                |4 0 0 0 34
                |.....***$......**$
                |***$**$
                |$$$$$$.....***$....****
                |$$$$$$*$**
                |4 36 37 38 39
                |5 0 33 35 40
                |6 5 20 30 41
                |$$$$***$****$.***$*
                |....**$...**.**$....****$.....***$
                |$$$$$$..**$*....*
                |4 43 44 0 45
                |$**$**$*$
                |4 47 0 0 0
                |.......*$.......*$.......*$
                |$.....*$*****$
                |4 49 50 0 0
                |5 46 48 51 0
                |$$$$$$.......*$.......*
                |$$$$$$*****$.....*
                |.......*$
                |$*....*$..**$
                |4 53 54 55 56
                |5 0 0 57 0
                |6 52 0 58 0
                |...**.**$....**$
                |**$.......*$......**$.......*$
                |4 60 61 0 0
                |5 0 62 0 0
                |6 0 63 0 0
                |$*$.***$****$***$
                |$$$$$.....***$....****$...**.**
                |....**$
                |4 65 66 0 67
                |$$$$$*$**$**
                |4 69 0 0 0
                |5 68 70 0 0
                |6 71 0 0 0
                |7 42 59 64 72
                """.trimMargin().lineSequence(),
            ),
        )
    }

    @Test
    fun pulsar_pixel_display_deserialization_is_correct() {
        val deserializationResult = serializer.deserializeToCellState(
            this::class.java
                .getResource("/patternfiles/pulsarpixeldisplay.mc")!!
                .readText()
                .lineSequence(),
        )
        assertIs<DeserializationResult.Successful>(deserializationResult)
        assertEquals(CellStateFormat.FixedFormat.Macrocell, deserializationResult.format)
        assertEquals(emptyList(), deserializationResult.warnings)
        assertTrue(
            this::class.java
                .getResource("/patternfiles/pulsarpixeldisplay.rle")!!
                .readText()
                .toCellState(fixedFormatCellStateSerializer = RunLengthEncodedCellStateSerializer)
                .equalsModuloOffset(deserializationResult.cellState),
        )
    }
}
